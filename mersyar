#!/bin/bash
set -e

# --- Helper Functions for Colors ---
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }
warning() { echo -e "\e[33m[WARN]\e[0m $1"; }

# --- Static Config ---
PROJECT_DIR="/root/mersyar-docker"
CLI_COMMAND_PATH="/usr/local/bin/mersyar"
GITHUB_USER="mersvpn" # Please confirm this is correct
GITHUB_REPO="mersyar"   # Please confirm this is correc




# ==============================================================================
#                      --- BACKUP LOGIC (from original script) ---
# ==============================================================================
setup_backup_job() {
    # This is the full backup logic from your original script
    cd "$PROJECT_DIR"
    info "--- Automated Backup Setup ---"
    local DB_NAME_FOR_BACKUP="mersyar_bot_db"
    read -p "Enter backup interval in minutes (e.g., 1440 for daily): " INTERVAL
    read -p "Enter the Telegram Bot Token for sending backups: " BACKUP_BOT_TOKEN
    read -p "Enter the destination Telegram Channel/Chat ID: " BACKUP_CHAT_ID
    if ! [[ "$INTERVAL" =~ ^[0-9]+$ ]] || [[ "$INTERVAL" -eq 0 ]]; then error "Interval must be a positive number."; return 1; fi
    local cron_schedule; if (( INTERVAL >= 1440 && INTERVAL % 1440 == 0 )); then local DAYS=$((INTERVAL / 1440)); cron_schedule="0 0 */${DAYS} * *"; elif (( INTERVAL >= 60 && INTERVAL % 60 == 0 )); then local HOURS=$((INTERVAL / 60)); cron_schedule="0 */${HOURS} * * *"; elif (( INTERVAL < 60 )); then cron_schedule="*/${INTERVAL} * * * *"; else error "Invalid interval."; return 1; fi
    cat << EOF > "${PROJECT_DIR}/backup_script.sh"
#!/bin/bash
set -e
BOT_TOKEN="\$1"; CHAT_ID="\$2"; PROJECT_DIR="${PROJECT_DIR}"; DB_CONTAINER="mersyar-db"; DB_NAME="${DB_NAME_FOR_BACKUP}"; TIMESTAMP=\$(date +%Y-%m-%d_%H-%M-%S); BACKUP_FILENAME="mersyar_backup_\${TIMESTAMP}.tar.gz"; DB_DUMP_FILENAME="\${DB_NAME}_dump_\${TIMESTAMP}.sql"; cd "\$PROJECT_DIR"; DB_ROOT_PASSWORD=\$(docker exec "\$DB_CONTAINER" printenv MYSQL_ROOT_PASSWORD | tr -d '\r'); docker exec -e MYSQL_PWD="\$DB_ROOT_PASSWORD" "\$DB_CONTAINER" mysqldump -u root "\$DB_NAME" > "\$DB_DUMP_FILENAME"; tar -czf "\$BACKUP_FILENAME" "\$DB_DUMP_FILENAME" .env; curl -s -o /dev/null -w "%{http_code}" -F "chat_id=\$CHAT_ID" -F "document=@\$BACKUP_FILENAME" -F "caption=Mersyar-Bot Backup (\${DB_NAME}) - \$(date)" "https://api.telegram.org/bot\$BOT_TOKEN/sendDocument"; rm "\$DB_DUMP_FILENAME" "\$BACKUP_FILENAME";
EOF
    chmod +x "${PROJECT_DIR}/backup_script.sh"; local cron_job="${cron_schedule} bash ${PROJECT_DIR}/backup_script.sh '$BACKUP_BOT_TOKEN' '$BACKUP_CHAT_ID' >/dev/null 2>&1 # MERSYAR_BACKUP_JOB"; (crontab -l 2>/dev/null | grep -v "# MERSYAR_BACKUP_JOB"; echo "$cron_job") | crontab -
    success "Backup job scheduled! Running an initial test..."; bash "${PROJECT_DIR}/backup_script.sh" "$BACKUP_BOT_TOKEN" "$BACKUP_CHAT_ID"
}

# ==============================================================================
#                              MANAGEMENT MENU (Original)
# ==============================================================================
manage_bot() {
    
    show_menu() {
       echo -e "\n--- Mersyar Bot Docker Manager ---"
       echo " 1) View Bot Logs (Live)"
       echo " 2) Restart Bot"
       echo " 3) Stop Bot & All Services"
       echo " 4) Start Bot & All Services"
       echo " 5) Update Bot (Rebuild from GitHub)"  # <--- Updated Text
       echo " 6) Re-run Installation / Change Settings"
       echo " 7) Configure Automated Backups"
       echo " 8) Exit"
       echo "------------------------------------"
       read -p "Select an option [1-8]: " option
       handle_option "$option"
    }

    handle_option() {
       cd "$PROJECT_DIR"
       case $1 in
           1)
               info "Tailing logs for mersyar. Press Ctrl+C to exit."
               docker compose logs -f bot
               show_menu
               ;;
           2)
               info "Restarting mersyar container..."
               if docker compose restart bot; then success "Bot restarted."; else error "Failed to restart bot."; fi
               show_menu
               ;;
           3)
               info "Stopping all services (bot, db, phpmyadmin)..."
               if docker compose down; then success "All services stopped."; else error "Failed to stop services."; fi
               show_menu
               ;;
           4)
               info "Starting all services..."
               if docker compose up -d; then success "All services started in the background."; else error "Failed to start services."; fi
               show_menu
               ;;
           5)
               # --- MODERN UPDATE LOGIC ---
               info "Updating bot system to the latest version..."
               warning "This process will rebuild the bot container."
               info "Note: Database migrations are handled automatically by the container."
                
               info "Step 1: Stopping current services..."
               docker compose down
                
               info "Step 2: Cleaning up build cache..."
               docker builder prune -f >/dev/null 2>&1
                
               info "Step 3: Building new image (Downloading latest code from GitHub)..."
               # This command uses the Dockerfile present in the image context or recreated by install script
               # To ensure it uses the LATEST Dockerfile from your repo, we rely on the build context downloading it.
               
               if ! docker compose build --no-cache bot; then
                   error "Failed to build the new image. Aborting update."
                   info "Attempting to restart previous version..."
                   docker compose up -d
                   show_menu; return
               fi
                
               info "Step 4: Starting services..."
               if docker compose up -d; then
                   success "Containers started successfully!"
                   success "The bot is now initializing. Check logs (Option 1) to see the migration status."
               else
                   error "Failed to start services."
               fi
               
               show_menu
               ;;
           6)
               warning "This will re-run the full installation process."
               read -p "Are you sure you want to continue? (y/n): " confirm
               if [[ "$confirm" == "y" ]]; then
                   bash "$CLI_COMMAND_PATH" --force-install
               else
                   info "Operation cancelled."
                   show_menu
               fi
               ;;
           7)
               setup_backup_job
               show_menu
               ;;
           8)
               echo "Exiting."
               exit 0
               ;;
           *)
               error "Invalid option. Please try again."
               show_menu
               ;;
       esac
    }
    show_menu
}

# ==============================================================================
#                              INSTALLATION LOGIC (Placeholder)
# ==============================================================================
install_bot() {
    # This part of the script will not be used in update-only mode, 
    # but is kept for the 'Re-run Installation' option to work.
    # It's the full installation logic from your original script.
    # To keep this response shorter, I've omitted the 100+ lines of install code.
    # In your REAL file, you should paste the FULL original install logic here.
    echo "Running the installation logic..."
    # PASTE THE FULL 'install_bot()' FUNCTION FROM YOUR ORIGINAL SCRIPT HERE
}

# ==============================================================================
#                                 MAIN LOGIC (Original)
# ==============================================================================
if [[ "$1" == "--force-install" ]]; then
    install_bot
    exit 0
fi

if [[ -f "$CLI_COMMAND_PATH" && -f "$PROJECT_DIR/docker-compose.yml" ]]; then
    manage_bot "$@"
else
    # To prevent accidental re-installation, we default to the menu.
    # If a user really wants to install, they can use option 6.
    manage_bot
fi
